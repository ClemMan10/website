---
import { Image } from "astro:assets";
import logo from "../assets/logo.webp";
 
function ensureTrailing(href: string) {
  if (!href) return href;
  // preserve absolute URLs and protocols
  if (href.startsWith('http') || href.startsWith('mailto:') || href.startsWith('tel:')) return href;
  // preserve local anchors
  if (href.startsWith('#')) return href;

  // split base and hash
  const [base, hash] = href.split('#');
  let b = base || '/';
  // ensure leading slash
  if (!b.startsWith('/')) b = '/' + b;
  // ensure trailing slash (except for root which is just '/')
  if (b !== '/' && !b.endsWith('/')) b = b + '/';
  return hash ? `${b}#${hash}` : b;
}
---

<nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
  <div class="navbar-brand">
    <!-- Logo + texte -->
    <a class="navbar-item brand-link" href={ensureTrailing('/') }>
      <Image src={logo} alt="Logo de In the Pouchett" />
      <span class="brand-text">In The Pouchett</span>
    </a>

    <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="websiteNavbar">
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
    </a>
  </div>

  <div id="websiteNavbar" class="navbar-menu">
    <div class="navbar-end">

      <div class="navbar-item has-dropdown is-hoverable desktop-dropdown">
        <a class="navbar-link" href={ensureTrailing('/')}>Le Studio</a>
        <div class="navbar-dropdown">
          <a class="navbar-item" href={ensureTrailing('/#reference')}>Références</a>
          <a class="navbar-item" href={ensureTrailing('/#materiel')}>Le Matériel</a>
        </div>
      </div>

      <div class="navbar-item has-dropdown is-hoverable desktop-dropdown">
        <a class="navbar-link" href={ensureTrailing('/live-sessions')}>Live Sessions</a>
        <div class="navbar-dropdown">
          <a class="navbar-item" href={ensureTrailing('/live-sessions/#formats')}>Formats</a>
          <a class="navbar-item" href={ensureTrailing('/live-sessions/#diffusion')}>Diffusion</a>
          <a class="navbar-item" href={ensureTrailing('/live-sessions/#tarifs')}>Tarifs</a>
        </div>
      </div>

      <a class="navbar-item desktop-item" href={ensureTrailing('/qui-sommes-nous')}>
        Qui sommes-nous ?
      </a>

      <div class="navbar-item">
        <a class="button is-info" id="nav-contact-btn" href="#" data-user="inthepouchett.studio" data-domain="gmail.com">
          <i class="fa-solid fa-envelope"></i> Contact
        </a>
      </div>

      <script is:inline>
        // Protection de l'email dans la navbar
        const navBtn = document.getElementById('nav-contact-btn');
        if (navBtn) {
          navBtn.href = 'mailto:' + navBtn.dataset.user + '@' + navBtn.dataset.domain;
        }
      </script>

    </div>
  </div>
</nav>

<script>
  const burger = document.querySelector(".navbar-burger");
  const menu = document.querySelector("#websiteNavbar");

  if (burger && menu) {
    burger.addEventListener("click", () => {
      burger.classList.toggle("is-active");
      menu.classList.toggle("is-active");
    });

    document.querySelectorAll("#websiteNavbar a").forEach(link => {
      link.addEventListener("click", () => {
        if (menu.classList.contains("is-active")) {
          setTimeout(() => {
            menu.classList.remove("is-active");
            burger.classList.remove("is-active");
          }, 100);
        }
      });
    });
  }
</script>

<style lang="scss">
@use "bulma/sass/components/navbar" with (
  $navbar-background-color: rgb(8, 15, 37),
  $navbar-height: 4rem
);
@use "bulma/sass/elements/button";

/* -----------------------
   Dropdown (desktop)
----------------------- */
.desktop-dropdown .navbar-dropdown {
  display: none;
  position: absolute;
  background-color: rgba(33,39,58,1);
  border-radius: 0.5rem;
}
.desktop-dropdown .navbar-dropdown a {
  color: white;
  background-color: rgba(33,39,58,1);
}
.desktop-dropdown .navbar-dropdown a:hover {
  color: #4358ff;
}
.desktop-dropdown:hover .navbar-dropdown {
  display: block;
}

/* -----------------------
   Couleur texte par défaut
----------------------- */
.navbar,
.navbar .navbar-item,
.navbar .navbar-link {
  color: #cbd5e1;
  -webkit-text-size-adjust: none;
  transition: background 0.2s, color 0.2s;
}
.navbar .navbar-item.has-dropdown:hover > .navbar-link {
  color: #ffffff;
  background-color: rgba(33,39,58,1);
}

/* -----------------------
   Item simple top-level
----------------------- */
.navbar .navbar-end > a.navbar-item {
  display: flex;
  align-items: center;
  height: 100%;
  padding: 0 1rem;
}
.navbar .navbar-end > a.navbar-item:hover {
  background-color: rgba(33,39,58,1);
  color: #ffffff;
}

/* -----------------------
   Brand (logo + texte)
----------------------- */
.navbar {
  height: 4rem;
  min-height: 4rem;
}
.navbar-brand {
  display: flex;
  align-items: center;
  height: 100%;
}
.navbar .brand-link {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  height: 100%;
  padding: 0.5rem 0.75rem; /* marge gauche/droite restaurée */
  color: #cbd5e1;
  transition: background 0.2s, color 0.2s;
}
.navbar .brand-link:hover {
  background-color: rgba(255, 255, 255, 0.1);
  color: #ffffff;
}
.navbar .brand-link img {
  display: block;
  height: 2rem;
  width: auto;
  object-fit: contain;
}
.navbar .brand-text {
  font-weight: 600;
  font-size: 1.1rem;
  line-height: 1;
}

/* -----------------------
   Bouton Contact
----------------------- */
.navbar-item .button.is-info {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  background: linear-gradient(45deg, #ea475f, #d57072);
  color: white;
  border: none;
  transition: all 0.2s ease; /* plus court pour plus de réactivité */
  transform: scale(1);
}

.navbar-item .button.is-info:hover {
  background: linear-gradient(45deg, #ea475f, #92dbf5);
  color: white;
  transform: scale(1.05); /* petit zoom */
  box-shadow: 0 4px 12px rgba(234, 71, 95, 0.4);
}

.navbar-item .button.is-info:active {
  transform: scale(0.95); /* effet pressé */
  box-shadow: 0 2px 6px rgba(234, 71, 95, 0.3); /* ombre plus courte */
}


/* -----------------------
   Burger
----------------------- */
.navbar-burger {
  display: none; /* caché en desktop */
}
@media (max-width: 1024px) {
  .navbar-burger {
    display: flex;
    align-items: center;
    height: 100%;
  }
  .navbar-menu.is-active { display: block; }

  .navbar-menu.is-active > .navbar-end > .navbar-item,
  .navbar-menu.is-active > .navbar-end > .desktop-dropdown > .navbar-link,
  .navbar-menu.is-active > .navbar-end > a.navbar-item.desktop-item {
    color: #cbd5e1;
    background-color: rgb(8, 15, 37);
    padding-left: 1.5rem;
  }

  .desktop-dropdown .navbar-dropdown {
    display: flex !important;
    flex-direction: column;
    position: relative;
    background-color: rgb(8, 15, 37);
    border-radius: 0.25rem;
  }
  .desktop-dropdown .navbar-dropdown a {
    padding-left: 2.5rem;
    color: #cbd5e1;
    background-color: rgb(8, 15, 37);
  }

  .navbar-menu.is-active .navbar-item:hover,
  .desktop-dropdown .navbar-dropdown a:hover {
    background-color: rgba(255, 255, 255, 0.1);
    color: white;
  }

  .navbar-link .arrow { display: none; }

  .navbar-menu.is-active > .navbar-end > a.navbar-item.desktop-item,
  .navbar-menu.is-active > .navbar-end > .navbar-item:last-child {
    padding-left: 3rem;
  }
  /* Espace avant le bouton Contact sur mobile */
  .navbar-menu.is-active > .navbar-end > .navbar-item:last-child {
    margin-top: 0.75rem;
  }
}
</style>
